# ************************ Dispatchable only workflow ************************
# Copyleft (c+) tobozo <https://github.com/tobozo> 2022-09-15
#
# This workflow is for library maintainers willing to test their
# changes on a private, local or public webserver.
#
# It can only be triggered manually from the actions tab.
#
# - Gen RSA && Fetches Root CA then populate spiffs/littlefs/progmem if applicable
# - Builds binaries (+signed version when applicable) from test suite folder (examples/anyFS/test)
# - Creates a JSON Manifest linking to every binary in the test suite
# - Bundles the compiled binaries and the manifest into a zip archive
# - Publishes the zip archive as an artifact downloadable from the actions tab
#
# A final publish method can eventually be used at the maintainer's discretion.
# See the commented blocks at the end of this workflow, and uncomment/edit to
# deploy the assets as gh-page, wiki or release.
#

name: Dispatchable build

on:
  workflow_dispatch:

    inputs:

      manifest_url:
        description: '‚ö†Ô∏è Complete URL to JSON Manifest'
        required: true
        default: 'https://server/fota/fota.json'
        type: string

      manifest_host:
        description: '‚ö†Ô∏è Hostname (e.g. github.com)'
        required: true
        default: 'server'
        type: string

      manifest_port:
        description: '‚ö†Ô∏è Port (e.g 80 or 443)'
        required: true
        default: '443'
        type: string

      manifest_bin_path:
        description: '‚ö†Ô∏è Path (no trailing slash)'
        required: true
        default: '/path/to/binaries'
        type: string

      firmware_type:
        description: 'Firmware Type'
        default: 'esp32-fota-http'
        required: true
        type: string

      board_fqbn:
        description: 'Arduino FQBN'
        required: true
        default: 'esp32:esp32:esp32'
        type: string

      partition_scheme:
        description: 'Partition scheme'
        required: true
        type: choice
        options:
        - default
        - min_spiffs
        - large_spiffs
        default: 'default'


jobs:

  gen_keys:

    name: Openssl stuff
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Generate openssl stuff
      run: |
        artifact_path=/home/runner/certs/
        privkey_path=$artifact_path/priv_key.pem
        pub_key_path=$artifact_path/rsa_key.pub
        root_ca_path=$artifact_path/root_ca.pem

        root_ca_h_path=$artifact_path/root_ca.h
        pub_key_h_path=$artifact_path/rsa_key.h

        mkdir -p $artifact_path

        ssl_host="${{ inputs.manifest_host }}"
        root_ca_c_prefix="const char* root_ca =\\"
        pub_key_c_prefix="const char* pub_key =\\"
        c_suffix="\"\";"

        # Retrieve a copy of a certificate chain using openssl and split contents in "const char*" C/C++ declaration
        openssl s_client -showcerts -connect $ssl_host:${{ inputs.manifest_port }} </dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > $root_ca_path
        echo $root_ca_c_prefix > $root_ca_h_path
        cat $root_ca_path | awk '{print "\"" $0 "\\n\"\\"}' >> $root_ca_h_path
        echo $c_suffix >> $root_ca_h_path

        # Generate privkey for later signing and split contents in "const char*" C/C++ declaration
        openssl genrsa -out $privkey_path 4096
        openssl rsa -in $privkey_path -pubout > $pub_key_path
        echo $pub_key_c_prefix > $pub_key_h_path
        cat $pub_key_path | awk '{print "\"" $0 "\\n\"\\"}' > $pub_key_h_path
        echo $c_suffix >> $pub_key_h_path

        echo "Generated files:"
        cat $pub_key_path
        cat $pub_key_h_path
        cat $root_ca_path
        cat $root_ca_h_path

    - name: Upload RootCA/PubKey as artifact
      uses: actions/upload-artifact@v2
      with:
        name: Certs
        path: |
          /home/runner/certs/**


  matrix_build:

    name: ${{ matrix.sketch }}
    runs-on: ubuntu-latest
    needs: gen_keys

    strategy:

      matrix:

        sketch:
        - 1.nosecurity.ino
        - 2.cert-in-spiffs.ino
        - 3.cert-in-progmem.ino
        - 4.cert-in-littlefs.ino
        - 5.sig-in-progmem.ino
        # insert more tests here
        - 99.final-stage.ino

    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Retrieve RootCA/PubKey
        uses: actions/download-artifact@v3
        with:
          name: Certs
          path: /home/runner/certs

      - name: Inject Manifest URL
        run: |
          # The '#define FOTA_URL' declaration will override the default fota_url in the test suite code
          full_ino_path=`find /home/runner/work/ | grep "${{ matrix.sketch }}"`
          echo -e "#define FOTA_URL \"${{ inputs.manifest_url }}\"\n$(cat $full_ino_path)" > $full_ino_path

      - name: Inject RootCA/PubKey if applicable
        if: (inputs.manifest_port  == '443' || inputs.manifest_port  == '4433')
        run: |
          root_ca_path=`dirname examples/anyFS/test/${{ matrix.sketch }}`/root_ca.h
          cat /home/runner/certs/root_ca.h > $root_ca_path
          pub_key_path=`dirname examples/anyFS/test/${{ matrix.sketch }}`/pub_key.h
          cat /home/runner/certs/root_ca.h > $pub_key

      - name: ${{ matrix.sketch }}
        uses: ArminJo/arduino-test-compile@v3
        with:
          platform-url: https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_dev_index.json
          arduino-board-fqbn: ${{ inputs.board_fqbn }}:PartitionScheme=${{inputs.partition_scheme}}
          required-libraries: ArduinoJson
          extra-arduino-lib-install-args: --no-deps
          extra-arduino-cli-args: "--warnings default " # see https://github.com/ArminJo/arduino-test-compile/issues/28
          sketch-names: ${{ matrix.sketch }}
          set-build-path: true
          # build-properties: ${{ toJson(matrix.build-properties) }}
          # arduino-platform: esp32:esp32@${{ matrix.sdk-version }}
          # extra-arduino-cli-args: ${{ matrix.extra-arduino-cli-args }}
          # debug-install: true

      - name: Sign and Save compiled binaries
        run: |
          mkdir -p /home/runner/builds
          cd /home/runner/work/
          full_ino_bin_path=`find . | grep "build/${{ matrix.sketch }}.bin"`
          echo "Bin path: $full_ino_bin_path"

          openssl dgst -sign /home/runner/certs/priv_key.pem -keyform PEM -sha256 -out firmware.sign -binary $full_ino_bin_path
          cat firmware.sign firmware.bin > $full_ino_bin_path.img

          cp "$full_ino_bin_path" /home/runner/builds/${{ matrix.sketch }}.bin
          cp "$full_ino_bin_path.img" /home/runner/builds/${{ matrix.sketch }}.signed.bin

      - name: Prepare data folder if applicable
        if: (inputs.manifest_port  == '443' || inputs.manifest_port  == '4433')
        run: |
          root_ca_path=`dirname examples/anyFS/test/${{ matrix.sketch }}`/root_ca.pem
          pub_key_path=`dirname examples/anyFS/test/${{ matrix.sketch }}`/rsa_key.pub

          cp /home/runner/certs/root_ca.pem $root_ca_path
          cp /home/runner/certs/rsa_key.pub $pub_key_path
          cp /home/runner/certs/root_ca.pem anyFS/data/
          cp /home/runner/certs/rsa_key.pub anyFS/data/

      - name: Create filesystem images
        run: |
          # Provide partition name=>size translation
          default_size=0x170000
          large_spiffs_size=0x6F0000
          min_spiffs_size=0x30000
          # Find mkspiffs and mklittlefs binaries ... ooh that's dirty :-)
          mkspiffs_esp32=~/.arduino15/packages/esp32*/tools/mkspiffs/*/mkspiffs
          mklittlefs_esp32=~/.arduino15/packages/esp32*/tools/mklittlefs/*/mklittlefs
          echo "[DEBUG] mkspiffs path: $mkspiffs_esp32"
          echo "[DEBUG] mklittlefs path: $mklittlefs_esp32"
          # Create the partition binaries
          $mkspiffs_esp32 -c examples/anyFS/data/ -p 256 -b 4096 -s $${{inputs.partition_scheme}}_size /home/runner/builds/2.cert-in-spiffs.spiffs.bin
          $mklittlefs_esp32 -c examples/anyFS/data/ -p 256 -b 4096 -s $${{inputs.partition_scheme}}_size /home/runner/builds/4.cert-in-littlefs.littlefs.bin

      - name: Upload artifact for Stage ${{ matrix.test-stage }}
        uses: actions/upload-artifact@v2
        with:
          name: TestSuite
          path: |
            /home/runner/builds/**


  post_build:

    name: Gather Artefacts
    runs-on: ubuntu-latest
    # wait until matrix jobs are all finished
    needs: matrix_build

    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Polulate JSON Manifest
        run: |
          firmware_json_path=/home/runner/builds/firmware.json
          mkdir -p /home/runner/builds
          cp .github/templates/firmware.test-suite.json $firmware_json_path
          sed -i -e 's/FIRMWARE_TYPE/${{ inputs.firmware_type }}/g' $firmware_json_path
          sed -i -e 's/FIRMWARE_HOST/${{ inputs.manifest_host }}/g' $firmware_json_path
          sed -i -e 's/FIRMWARE_PORT/${{ inputs.manifest_port }}/g' $firmware_json_path
          sed -i -e 's~FIRMWARE_PATH~${{ inputs.manifest_bin_path }}~g' $firmware_json_path
          cat $firmware_json_path

      - name: Update artifacts with new JSON Manifest
        uses: actions/upload-artifact@v2
        with:
          name: TestSuite
          path: |
            /home/runner/builds/**


      # Eventually enable one of those

      #- name: Deploy üöÄ artifacts as gh-pages
        #uses: JamesIves/github-pages-deploy-action@v4
        #with:
          #branch: gh-pages # The branch the action should deploy to.
          #folder: /home/runner/builds/ # The folder the action should deploy.


      # /!\ This one requires a personal access token
      #- name: Deploy üöÄ artifacts as Wiki assets
        #uses: SwiftDocOrg/github-wiki-publish-action@v1
        #with:
          #path: |
            #/home/runner/builds/**
        #env:
          #GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}


      # /!\ This one may require some tuning
      #- name: Deploy üöÄ artifacts as Release
        #uses: softprops/action-gh-release@v1
        #if: startsWith(github.ref, 'refs/tags/')
        #with:
          #files: |
            #/home/runner/builds/**

